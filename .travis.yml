sudo: required

language: php

php:
  - "7.2"
  - "7.1"
  - "7.0"
  - "5.6"

env:
  - APPLICATION_ENV=dev

addons:
  hosts:
    - mysql-container

services:
  - docker

before_install:
  - composer config --global github-oauth.github.com ${GITHUB_TOKEN}
  - sudo service mysql stop || echo "mysql not stopped"

install:
  - sed -i "s~\(FROM byjg/php:\)[5-7]\.[0-9]~\1${TRAVIS_PHP_VERSION:0:3}~" docker/Dockerfile-dev
  - docker run -d -p 3306:3306 --env MYSQL_ROOT_PASSWORD=password --name mysql-container mysql:5.7
  - composer install
  - composer restdocs
  - composer migrate -- reset --yes
  - composer docker-build
  - composer docker-run
  - docker ps -a
  - sleep 15

script:
  - vendor/bin/phpunit
