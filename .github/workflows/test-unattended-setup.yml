name: Test Unattended Setup

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  DB_DATABASE: mydb
  DB_USERNAME: root
  DB_PASSWORD: password

jobs:
  test-unattended-setup:
    runs-on: ubuntu-latest

    services:
      mysql-container:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: false
          MYSQL_ROOT_PASSWORD: ${{ env.DB_PASSWORD }}
          MYSQL_DATABASE: ${{ env.DB_DATABASE }}
        ports:
          - 3306:3306
        options: --name mysql-container --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, json, mysql, pdo, pdo_mysql

      - name: Get sanitized branch name
        id: branch
        run: |
          # Replace / with - in branch name for composer version
          BRANCH_NAME="${{ github.ref_name }}"
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          echo "name=$SANITIZED_BRANCH" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH_NAME -> dev-$SANITIZED_BRANCH"

      - name: Verify prerequisites
        run: |
          php --version
          git --version
          docker --version || echo "Docker not required for this test"

      - name: Create setup.json for unattended mode
        run: |
          cat > setup.json << 'EOF'
          {
            "git_user_name": "John Doe",
            "git_user_email": "john.doe@example.com",
            "php_version": "8.4",
            "namespace": "MyApp",
            "composer_name": "mycompany/myapp",
            "mysql_connection": "mysql://root:password@127.0.0.1:3306/mydb",
            "timezone": "America/New_York",
            "install_examples": true
          }
          EOF
          cat setup.json

      - name: Create project using unattended setup
        run: |
          composer -sdev create-project --no-interaction byjg/rest-reference-architecture test-project dev-${{ steps.branch.outputs.name }}

      - name: Verify setup.json was used
        run: |
          if [ -f setup.json ]; then
            echo "✓ setup.json still exists (not deleted)"
          else
            echo "✗ setup.json was deleted"
            exit 1
          fi

      - name: Verify project was created with correct configuration
        working-directory: test-project
        run: |
          # Check namespace in composer.json
          if grep -q "mycompany/myapp" composer.json; then
            echo "✓ Composer name is correct: mycompany/myapp"
          else
            echo "✗ Composer name not found"
            cat composer.json
            exit 1
          fi

          # Check if files exist
          if [ -f src/Model/User.php ]; then
            echo "✓ User model exists"
          else
            echo "✗ User model not found"
            exit 1
          fi

          # Check if examples were installed
          if [ -f src/Model/DummyActiveRecord.php ]; then
            echo "✓ Examples were installed (DummyActiveRecord exists)"
          else
            echo "✗ Examples were not installed"
            exit 1
          fi

          # Check namespace in source files
          if grep -q "namespace MyApp" src/Model/User.php; then
            echo "✓ Namespace is correct: MyApp"
          else
            echo "✗ Namespace not correct"
            cat src/Model/User.php | head -20
            exit 1
          fi

          # Check git config
          GIT_USER=$(git config user.name)
          GIT_EMAIL=$(git config user.email)

          if [ "$GIT_USER" = "John Doe" ]; then
            echo "✓ Git user name is correct: $GIT_USER"
          else
            echo "✗ Git user name not correct: $GIT_USER"
            exit 1
          fi

          if [ "$GIT_EMAIL" = "john.doe@example.com" ]; then
            echo "✓ Git user email is correct: $GIT_EMAIL"
          else
            echo "✗ Git user email not correct: $GIT_EMAIL"
            exit 1
          fi

      - name: Run database migrations
        working-directory: test-project
        run: |
          composer migrate -- --env=test update

      - name: Run tests
        working-directory: test-project
        run: |
          composer test -- --env=test

      - name: Verify changes were made
        working-directory: test-project
        run: |
          echo "=== Composer.json content ==="
          cat composer.json | grep -A 5 "name"

          echo ""
          echo "=== Git configuration ==="
          git config user.name
          git config user.email

          echo ""
          echo "=== Sample source file ==="
          head -20 src/Model/User.php

          echo ""
          echo "=== Directory structure ==="
          ls -la src/Model/
          ls -la src/Rest/

          echo ""
          echo "✓ All verifications passed!"

      - name: Test invalid configuration (should fail)
        if: always()
        run: |
          # Rename valid setup.json temporarily
          mv setup.json setup.json.backup

          # Create invalid setup.json
          cat > setup.json << 'EOF'
          {
            "php_version": "7.4",
            "namespace": "TestApp"
          }
          EOF

          # This should fail
          set +e
          composer -sdev create-project --no-interaction byjg/rest-reference-architecture test-invalid dev-${{ steps.branch.outputs.name }} 2>&1 | tee output.log
          EXIT_CODE=$?
          set -e

          # Restore original setup.json
          mv setup.json.backup setup.json

          if [ $EXIT_CODE -ne 0 ]; then
            if grep -q "Invalid php_version" output.log; then
              echo "✓ Invalid configuration correctly rejected"
            else
              echo "✗ Expected validation error not found"
              cat output.log
              exit 1
            fi
          else
            echo "✗ Invalid configuration was not rejected"
            exit 1
          fi
